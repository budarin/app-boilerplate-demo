<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Тест центрирования иконки splash screen по экрану</title>
        <style>
            @property --offset-y {
                inherits: false;
                initial-value: 0;
                syntax: '<length>';
            }

            @property --offset-x {
                inherits: false;
                initial-value: 0;
                syntax: '<length>';
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            .icon {
                position: fixed;
                inset-block-start: 50%;
                inset-inline-start: 50%;
                transform: translate(calc(-50% + var(--offset-x)), calc(-50% + var(--offset-y)));

                inline-size: 120px;
                block-size: 120px;
                border-radius: 50%;

                background: linear-gradient(135deg, #41d1ff 0%, #bd34fe 100%);
            }
        </style>
    </head>
    <body>
        <div class="icon" id="icon"></div>

        <script>
            const STORAGE_PREFIX = 'splash_screen_offsets_';

            function getOrientation() {
                if (screen.orientation && typeof screen.orientation.angle !== 'undefined') {
                    return screen.orientation.angle;
                }
                return window.orientation || 0;
            }

            function getStorageKey() {
                return `${STORAGE_PREFIX}${getOrientation()}`;
            }

            function loadOffsets() {
                const stored = localStorage.getItem(getStorageKey());
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            function saveOffsets(topOffset, leftOffset) {
                localStorage.setItem(
                    getStorageKey(),
                    JSON.stringify({ top: topOffset, left: leftOffset })
                );
            }

            function calibrate(event) {
                const touch = event.touches ? event.touches[0] : event;
                const screenX = touch.screenX;
                const screenY = touch.screenY;
                const clientX = touch.clientX;
                const clientY = touch.clientY;

                const topOffset = screenY - clientY;
                const leftOffset = screenX - clientX;

                const existing = loadOffsets();
                const hasChanged =
                    !existing ||
                    Math.abs(existing.top - topOffset) > 1 ||
                    Math.abs(existing.left - leftOffset) > 1;

                if (hasChanged) {
                    saveOffsets(topOffset, leftOffset);
                }

                applyOffsets(topOffset, leftOffset);
            }

            function applyOffsets(topOffset, leftOffset) {
                const offsetY = (window.screen.height - window.innerHeight) / 2 - topOffset;
                const offsetX = (window.screen.width - window.innerWidth) / 2 - leftOffset;

                document.documentElement.style.setProperty('--offset-x', `${offsetX.toFixed(2)}px`);
                document.documentElement.style.setProperty('--offset-y', `${offsetY.toFixed(2)}px`);
            }

            function initializeOffsets() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                }
            }

            function handleOrientationChange() {
                setTimeout(() => {
                    const offsets = loadOffsets();
                    if (offsets) {
                        applyOffsets(offsets.top, offsets.left);
                    } else if (navigator.userActivation?.hasBeenActive) {
                        const diffHeight = window.screen.height - window.innerHeight;
                        const diffWidth = window.screen.width - window.innerWidth;

                        const centerX = window.innerWidth / 2;
                        const centerY = window.innerHeight / 2;

                        const touch = new Touch({
                            identifier: Date.now(),
                            target: document.body,
                            clientX: centerX,
                            clientY: centerY,
                            screenX: centerX,
                            screenY: centerY,
                            radiusX: 5,
                            radiusY: 5,
                            rotationAngle: 0,
                            force: 0.5,
                        });

                        const customEvent = new TouchEvent('touchstart', {
                            bubbles: true,
                            cancelable: true,
                            touches: [touch],
                            targetTouches: [touch],
                            changedTouches: [touch],
                            ctrlKey: false,
                            shiftKey: false,
                            altKey: false,
                            metaKey: false,
                        });

                        calibrate(customEvent);
                    } else {
                        document.addEventListener('touchstart', calibrate, {
                            passive: true,
                            once: true,
                        });
                    }
                }, 150);
            }

            function init() {
                if ('ontouchstart' in window) {
                    document.addEventListener('touchstart', calibrate, { passive: true });
                    window.addEventListener('orientationchange', handleOrientationChange);
                }

                initializeOffsets();
            }

            init();
        </script>
    </body>
</html>
