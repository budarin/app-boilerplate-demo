<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Тест центрирования иконки splash screen по экрану</title>
        <style>
            @property --offset-y {
                inherits: false;
                initial-value: 0;
                syntax: '<length>';
            }

            @property --offset-x {
                inherits: false;
                initial-value: 0;
                syntax: '<length>';
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            .icon {
                position: fixed;
                inset-block-start: 50%;
                inset-inline-start: 50%;
                transform: translate(calc(-50% + var(--offset-x)), calc(-50% + var(--offset-y)));

                inline-size: 120px;
                block-size: 120px;
                border-radius: 50%;

                background: linear-gradient(135deg, #41d1ff 0%, #bd34fe 100%);
            }

            .icon::before,
            .icon::after {
                pointer-events: none;
                content: '';

                position: absolute;
                z-index: 1;
                inset-block-start: 50%;
                inset-inline-start: 50%;

                background: rgb(0 0 0 / 80%);
            }

            .icon::before {
                transform: translate(-50%, -50%);
                inline-size: 2px;
                block-size: 100%;
            }

            .icon::after {
                transform: translate(-50%, -50%);
                inline-size: 100%;
                block-size: 2px;
            }
        </style>
    </head>
    <body>
        <div class="icon" id="icon"></div>
        <div
            id="debugPanel"
            style="
                pointer-events: auto;
                cursor: pointer;

                position: fixed;
                inset-block-start: 10px;
                inset-inline-end: 10px;

                padding: 4px;

                font-family: monospace;
                line-height: 1.2;

                background: rgb(255 255 255 / 70%);
            "
        ></div>

        <script>
            const STORAGE_PREFIX = 'splash_screen_offsets_';

            function getOrientation() {
                if (screen.orientation && typeof screen.orientation.angle !== 'undefined') {
                    return screen.orientation.angle;
                }
                return window.orientation || 0;
            }

            function getStorageKey() {
                return `${STORAGE_PREFIX}${getOrientation()}`;
            }

            function loadOffsets() {
                const stored = localStorage.getItem(getStorageKey());
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            function saveOffsets(topOffset, leftOffset) {
                localStorage.setItem(
                    getStorageKey(),
                    JSON.stringify({ top: topOffset, left: leftOffset })
                );
            }

            function updateDebugPanel() {
                const panel = document.getElementById('debugPanel');
                if (!panel) return;

                const offsets = loadOffsets();
                const orientation = getOrientation();
                const computedStyle = getComputedStyle(document.documentElement);
                const offsetX = computedStyle.getPropertyValue('--offset-x').trim();
                const offsetY = computedStyle.getPropertyValue('--offset-y').trim();

                const screenCenterX = window.screen.width / 2;
                const screenCenterY = window.screen.height / 2;
                const viewportCenterX = window.innerWidth / 2;
                const viewportCenterY = window.innerHeight / 2;

                const icon = document.getElementById('icon');
                const iconTransform = icon ? getComputedStyle(icon).transform : 'N/A';
                const iconRect = icon ? icon.getBoundingClientRect() : null;
                const iconCenterX = iconRect ? iconRect.left + iconRect.width / 2 : 'N/A';
                const iconCenterY = iconRect ? iconRect.top + iconRect.height / 2 : 'N/A';

                let calcText = '';
                if (offsets) {
                    const viewportCenterOnScreenX = offsets.left + viewportCenterX;
                    const viewportCenterOnScreenY = offsets.top + viewportCenterY;
                    const calculatedOffsetX = screenCenterX - viewportCenterOnScreenX;
                    const calculatedOffsetY = screenCenterY - viewportCenterOnScreenY;
                    calcText = `calc: viewportCenter на экране: ${viewportCenterOnScreenX.toFixed(1)}×${viewportCenterOnScreenY.toFixed(1)}
calc: должен быть offset: ${calculatedOffsetX.toFixed(1)}×${calculatedOffsetY.toFixed(1)}`;
                }

                const text = `Ориентация: ${orientation}°
Экран: ${window.screen.width}×${window.screen.height}
Viewport: ${window.innerWidth}×${window.innerHeight}
${
    offsets
        ? `Top offset: ${offsets.top.toFixed(1)}px
Left offset: ${offsets.left.toFixed(1)}px`
        : 'Не калибровано'
}
screenCenter: ${screenCenterX.toFixed(1)}×${screenCenterY.toFixed(1)}
viewportCenter: ${viewportCenterX.toFixed(1)}×${viewportCenterY.toFixed(1)}
${calcText}
--offset-x: ${offsetX || '0'}
--offset-y: ${offsetY || '0'}
transform: ${iconTransform}
iconCenter: ${typeof iconCenterX === 'number' ? `${iconCenterX.toFixed(1)}×${iconCenterY.toFixed(1)}` : iconCenterX}
hasBeenActive: ${navigator.userActivation?.hasBeenActive || false}`;

                panel.innerHTML = text
                    .split('\n')
                    .filter((line) => line.trim())
                    .map((line) => `<div>${line}</div>`)
                    .join('');

                panel.onclick = () => {
                    navigator.clipboard.writeText(text.trim());
                    const originalBg = panel.style.background;
                    panel.style.background = 'rgba(144,238,144,0.7)';
                    setTimeout(() => {
                        panel.style.background = originalBg;
                    }, 200);
                };
            }

            function calibrate(event) {
                const touch = event.touches ? event.touches[0] : event;
                const screenX = touch.screenX;
                const screenY = touch.screenY;
                const clientX = touch.clientX;
                const clientY = touch.clientY;

                if (typeof screenX === 'undefined' || typeof screenY === 'undefined') {
                    return;
                }

                const topOffset = screenY - clientY;
                const leftOffset = screenX - clientX;

                const existing = loadOffsets();
                const hasChanged =
                    !existing ||
                    Math.abs(existing.top - topOffset) > 1 ||
                    Math.abs(existing.left - leftOffset) > 1;

                if (hasChanged) {
                    saveOffsets(topOffset, leftOffset);
                }

                applyOffsets(topOffset, leftOffset);
                updateDebugPanel();
            }

            function applyOffsets(topOffset, leftOffset) {
                const screenCenterY = window.screen.height / 2;
                const screenCenterX = window.screen.width / 2;
                const viewportCenterY = window.innerHeight / 2;
                const viewportCenterX = window.innerWidth / 2;

                // Иконка находится в центре viewport (50%)
                // Центр viewport от верха/лева экрана = topOffset + viewportCenter
                // Центр экрана = screenCenter
                // Смещение = центр экрана - центр viewport (чтобы сдвинуть иконку к центру экрана)
                const offsetY = screenCenterY - (topOffset + viewportCenterY);
                const offsetX = screenCenterX - (leftOffset + viewportCenterX);

                const offsetXStr = `${offsetX.toFixed(2)}px`;
                const offsetYStr = `${offsetY.toFixed(2)}px`;

                document.documentElement.style.setProperty('--offset-x', offsetXStr);
                document.documentElement.style.setProperty('--offset-y', offsetYStr);

                // Принудительное обновление через requestAnimationFrame
                requestAnimationFrame(() => {
                    updateDebugPanel();
                });
            }

            function initializeOffsets() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                }
                updateDebugPanel();
            }

            function handleOrientationChange() {
                setTimeout(() => {
                    const offsets = loadOffsets();
                    updateDebugPanel();
                    if (offsets) {
                        applyOffsets(offsets.top, offsets.left);
                    } else {
                        document.addEventListener('touchstart', calibrate, {
                            passive: true,
                            once: true,
                        });
                    }
                }, 150);
            }

            function init() {
                if ('ontouchstart' in window) {
                    document.addEventListener('touchstart', calibrate, { passive: true });
                    window.addEventListener('orientationchange', handleOrientationChange);
                }

                initializeOffsets();
            }

            init();
        </script>
    </body>
</html>
