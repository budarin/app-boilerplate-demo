<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Тест центрирования иконки splash screen по экрану</title>
        <style>
            @property --offset-x {
                inherits: true;
                /* stylelint-disable-next-line */
                initial-value: 0px;
                syntax: '<length>';
            }

            @property --offset-y {
                inherits: true;
                /* stylelint-disable-next-line */
                initial-value: 0px;
                syntax: '<length>';
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            .icon {
                will-change: transform;

                position: fixed;
                inset-block-start: 50%;
                inset-inline-start: 50%;
                transform: translate(calc(-50% + var(--offset-x)), calc(-50% + var(--offset-y)));

                inline-size: 120px;
                block-size: 120px;
                border-radius: 50%;

                background: linear-gradient(135deg, #41d1ff 0%, #bd34fe 100%);
            }

            .icon::before,
            .icon::after {
                pointer-events: none;
                content: '';

                position: absolute;
                z-index: 1;
                inset-block-start: 50%;
                inset-inline-start: 50%;

                background: rgb(0 0 0 / 80%);
            }

            .icon::before {
                transform: translate(-50%, -50%);
                inline-size: 2px;
                block-size: 100%;
            }

            .icon::after {
                transform: translate(-50%, -50%);
                inline-size: 100%;
                block-size: 2px;
            }
        </style>
    </head>
    <body>
        <div class="icon" id="icon"></div>

        <script>
            const STORAGE_PREFIX = 'splash_screen_offsets_';

            function getOrientation() {
                if (screen.orientation && typeof screen.orientation.angle !== 'undefined') {
                    return screen.orientation.angle;
                }
                return window.orientation || 0;
            }

            function getStorageKey() {
                return `${STORAGE_PREFIX}${getOrientation()}`;
            }

            function loadOffsets() {
                const stored = localStorage.getItem(getStorageKey());
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            function saveOffsets(topOffset, leftOffset) {
                localStorage.setItem(
                    getStorageKey(),
                    JSON.stringify({ top: topOffset, left: leftOffset })
                );
            }

            function calibrate(event) {
                const touch = event.touches ? event.touches[0] : event;
                const screenX = touch.screenX;
                const screenY = touch.screenY;
                const clientX = touch.clientX;
                const clientY = touch.clientY;
                const topOffset = screenY - clientY;
                const leftOffset = screenX - clientX;

                const existing = loadOffsets();
                const hasChanged =
                    !existing ||
                    Math.abs(existing.top - topOffset) > 1 ||
                    Math.abs(existing.left - leftOffset) > 1;

                if (hasChanged) {
                    saveOffsets(topOffset, leftOffset);
                }

                applyOffsets(topOffset, leftOffset);
            }

            function applyOffsets(topOffset, leftOffset) {
                const screenCenterY = window.screen.height / 2;
                const screenCenterX = window.screen.width / 2;
                const viewportCenterY = window.innerHeight / 2;
                const viewportCenterX = window.innerWidth / 2;

                const offsetY = screenCenterY - (topOffset + viewportCenterY);
                const offsetX = screenCenterX - (leftOffset + viewportCenterX);

                const offsetXStr = `${offsetX.toFixed(2)}px`;
                const offsetYStr = `${offsetY.toFixed(2)}px`;

                document.documentElement.style.setProperty('--offset-x', offsetXStr);
                document.documentElement.style.setProperty('--offset-y', offsetYStr);
            }

            function initializeOffsets() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                } else {
                    document.addEventListener('touchstart', calibrate, {
                        passive: true,
                        once: true,
                    });
                }
            }

            function handleOrientationChange() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                } else {
                    window.addEventListener('touchstart', calibrate, { passive: true, once: true });
                }
            }

            function init() {
                initializeOffsets();

                if ('ontouchstart' in window) {
                    window.addEventListener('orientationchange', handleOrientationChange);
                }
            }

            init();
        </script>
    </body>
</html>
