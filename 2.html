<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>–¢–µ—Å—Ç —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ splash screen –ø–æ —ç–∫—Ä–∞–Ω—É</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            .icon {
                position: fixed;
                inset-block-start: var(--icon-top, 50%);
                inset-inline-start: var(--icon-left, 50%);
                transform: translate(-50%, -50%);

                inline-size: 120px;
                block-size: 120px;
                border-radius: 50%;

                background: linear-gradient(135deg, #41d1ff 0%, #bd34fe 100%);
            }

            .debug-panel {
                pointer-events: auto;
                cursor: pointer;

                position: fixed;
                inset-block-start: 10px;
                inset-inline-end: 10px;

                padding: 8px;
                border-radius: 4px;

                font-family: monospace;
                font-size: 10px;
                line-height: 1.3;
                color: #000;

                background: rgb(255 255 255 / 70%);
            }

            .debug-row {
                margin-block-end: 2px;
                white-space: nowrap;
            }
        </style>
    </head>
    <body>
        <div class="icon" id="icon"></div>
        <div class="debug-panel" id="debugPanel"></div>

        <script>
            const STORAGE_PREFIX = 'splash_screen_offsets_';

            function getOrientation() {
                if (screen.orientation && typeof screen.orientation.angle !== 'undefined') {
                    return screen.orientation.angle;
                }
                return window.orientation || 0;
            }

            function getStorageKey() {
                const angle = getOrientation();
                return `${STORAGE_PREFIX}${angle}`;
            }

            // ===== –†–∞–±–æ—Ç–∞ —Å localStorage =====

            function loadOffsets() {
                const key = getStorageKey();
                const stored = localStorage.getItem(key);
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            function saveOffsets(topOffset, leftOffset) {
                const key = getStorageKey();
                const data = {
                    top: topOffset,
                    left: leftOffset,
                };
                localStorage.setItem(key, JSON.stringify(data));
            }

            // ===== –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ touchstart =====

            function calibrate(event) {
                const touch = event.touches ? event.touches[0] : event;
                let screenX = touch.screenX;
                let screenY = touch.screenY;
                const clientX = touch.clientX;
                const clientY = touch.clientY;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å screenX/Y
                if (
                    typeof screenX === 'undefined' ||
                    typeof screenY === 'undefined' ||
                    screenX === 0 ||
                    screenY === 0
                ) {
                    // Fallback —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ (–µ—Å–ª–∏ –æ–∫–Ω–æ —Å–¥–≤–∏–Ω—É—Ç–æ)
                    if (window.screenX > 0 || window.screenY > 0) {
                        screenX = window.screenX + clientX;
                        screenY = window.screenY + clientY;
                    } else {
                        // –ù–∞ touch —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –±–µ–∑ screenX/Y - –Ω–µ –º–æ–∂–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å, –≤—ã—Ö–æ–¥–∏–º
                        return;
                    }
                }

                // –í—ã—á–∏—Å–ª—è–µ–º offset'—ã –æ—Ç –∫—Ä–∞—ë–≤ —ç–∫—Ä–∞–Ω–∞
                const topOffset = screenY - clientY;
                const leftOffset = screenX - clientX;

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
                updateDebugPanel({
                    screenY,
                    clientY,
                    topOffset,
                    screenX,
                    clientX,
                    leftOffset,
                    debugInfo: `calibrate called: top=${topOffset.toFixed(1)}, left=${leftOffset.toFixed(1)}`,
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const existing = loadOffsets();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è (—Å –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é 1px)
                const hasChanged =
                    !existing ||
                    Math.abs(existing.top - topOffset) > 1 ||
                    Math.abs(existing.left - leftOffset) > 1;

                if (hasChanged) {
                    saveOffsets(topOffset, leftOffset);
                }

                // –í—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º offset'—ã –ø–æ—Å–ª–µ –∫–∞—Å–∞–Ω–∏—è
                applyOffsets(topOffset, leftOffset);
            }

            // ===== –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ offset'–æ–≤ –∫ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º =====

            function applyOffsets(topOffset, leftOffset) {
                // –ï—Å–ª–∏ –Ω–µ—Ç touch (–¥–µ—Å–∫—Ç–æ–ø), —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ viewport
                if (!('ontouchstart' in window)) {
                    document.documentElement.style.setProperty('--icon-top', '50%');
                    document.documentElement.style.setProperty('--icon-left', '50%');
                    return;
                }

                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ü–µ–Ω—Ç—Ä–∞ —ç–∫—Ä–∞–Ω–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö viewport
                const screenCenterY = window.screen.height / 2;
                const screenCenterX = window.screen.width / 2;

                const iconTop = screenCenterY - topOffset;
                const iconLeft = screenCenterX - leftOffset;

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
                updateDebugPanel({
                    screenCenterY,
                    screenCenterX,
                    iconTop,
                    iconLeft,
                    topOffset,
                    leftOffset,
                });

                document.documentElement.style.setProperty('--icon-top', `${iconTop.toFixed(2)}px`);
                document.documentElement.style.setProperty(
                    '--icon-left',
                    `${iconLeft.toFixed(2)}px`
                );
            }

            // ===== –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å =====

            function updateDebugPanel(data = {}) {
                const panel = document.getElementById('debugPanel');
                if (!panel) return;

                const offsets = loadOffsets();
                const screenHeight = window.screen.height;
                const screenWidth = window.screen.width;
                const innerHeight = window.innerHeight;
                const innerWidth = window.innerWidth;
                const orientation = getOrientation();

                const computedStyle = getComputedStyle(document.documentElement);
                const iconTop = computedStyle.getPropertyValue('--icon-top').trim();
                const iconLeft = computedStyle.getPropertyValue('--icon-left').trim();

                const debugText = `
–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: ${orientation}¬∞
–≠–∫—Ä–∞–Ω: ${screenWidth}√ó${screenHeight}
Viewport: ${innerWidth}√ó${innerHeight}
${
    offsets
        ? `Top offset: ${offsets.top.toFixed(1)}px
Left offset: ${offsets.left.toFixed(1)}px`
        : '–ù–µ –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–æ'
}
${
    data.screenCenterY !== undefined
        ? `–¶–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ Y: ${data.screenCenterY.toFixed(1)}px
–¶–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ X: ${data.screenCenterX?.toFixed(1) || '‚Äî'}px
–ò–∫–æ–Ω–∫–∞ top: ${data.iconTop?.toFixed(1) || '‚Äî'}px
–ò–∫–æ–Ω–∫–∞ left: ${data.iconLeft?.toFixed(1) || '‚Äî'}px`
        : ''
}
${
    data.screenY !== undefined
        ? `Touch screenY: ${data.screenY.toFixed(1)}
Touch clientY: ${data.clientY.toFixed(1)}
Touch screenX: ${data.screenX?.toFixed(1) || '‚Äî'}
Touch clientX: ${data.clientX?.toFixed(1) || '‚Äî'}`
        : ''
}
CSS top: ${iconTop || '50%'}
CSS left: ${iconLeft || '50%'}
hasBeenActive: ${navigator.userActivation?.hasBeenActive || false}
${data.debugInfo ? `DEBUG: ${data.debugInfo}` : ''}
`;

                panel.innerHTML = debugText
                    .split('\n')
                    .filter((line) => line.trim())
                    .map((line) => `<div class="debug-row">${line}</div>`)
                    .join('');

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                panel.onclick = () => {
                    navigator.clipboard.writeText(debugText.trim()).then(() => {
                        const originalBg = panel.style.background;
                        panel.style.background = 'rgb(144 238 144 / 70%)';
                        setTimeout(() => {
                            panel.style.background = originalBg;
                        }, 200);
                    });
                };
            }

            // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è offset'–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ =====

            function initializeOffsets() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                    return true;
                }
                // –ï—Å–ª–∏ –Ω–µ—Ç offset'–æ–≤ –∏ –Ω–µ—Ç touch - —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ viewport (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞)
                if (!('ontouchstart' in window)) {
                    applyOffsets(0, 0);
                }
                return false;
            }

            // ===== –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ =====

            function handleOrientationChange() {
                // –î–∞–µ–º –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä—É –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                setTimeout(() => {
                    const currentOrientation = getOrientation();
                    const offsets = loadOffsets();
                    const hasBeenActive = navigator.userActivation?.hasBeenActive;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–∫—É –ü–ï–†–ï–î –ª—é–±–æ–π –ª–æ–≥–∏–∫–æ–π
                    const debugPanel = document.getElementById('debugPanel');

                    let debugMessages = [`üî• ORIENTATION CHANGE: ${currentOrientation}¬∞`];
                    debugMessages.push(`hasOffsets: ${!!offsets}, hasBeenActive: ${hasBeenActive}`);

                    if (offsets) {
                        debugMessages.push(
                            `‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ: top=${offsets.top.toFixed(1)}, left=${offsets.left.toFixed(1)}`
                        );
                        applyOffsets(offsets.top, offsets.left);
                        updateDebugPanel({ debugInfo: debugMessages.join(' | ') });
                        // –ó–µ–ª–µ–Ω—ã–π –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏, —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ –±–µ–ª—ã–π
                        if (debugPanel) {
                            debugPanel.style.background = 'rgb(200 255 200 / 90%)';
                            setTimeout(() => {
                                debugPanel.style.background = 'rgb(255 255 255 / 70%)';
                            }, 1000);
                        }
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç offset'–æ–≤ - –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
                        if (debugPanel) {
                            debugPanel.style.background = 'rgb(255 200 200 / 90%)';
                        }
                        // –ï—Å–ª–∏ –Ω–µ—Ç offset'–æ–≤ –¥–ª—è –Ω–æ–≤–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                        if (hasBeenActive) {
                            debugMessages.push('üî¥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ');

                            // –í–ê–ñ–ù–û: –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –í–°–ï–• –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–π (0¬∞, 90¬∞, 180¬∞, 270¬∞)
                            // –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å offset'—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–π –Ω–∞–ø—Ä—è–º—É—é!
                            // –ö–∞–∂–¥–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ offset'—ã, –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ —Ä–∞–∑–º–µ—Ä–æ–≤
                            const diffHeight = window.screen.height - window.innerHeight;
                            const diffWidth = window.screen.width - window.innerWidth;

                            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –≤—Å–µ—Ö –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–π:
                            // Viewport –æ–±—ã—á–Ω–æ —Å–º–µ—â–µ–Ω –∏–∑-–∑–∞ UI –±—Ä–∞—É–∑–µ—Ä–∞ (–∞–¥—Ä–µ—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏ —Ç.–¥.)
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ: 30% —Å–≤–µ—Ä—Ö—É –æ—Ç –æ–±—â–µ–π —Ä–∞–∑–Ω–∏—Ü—ã
                            // –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø–æ–∑–≤–æ–ª–∏—Ç calibrate() –ø–æ–ª—É—á–∏—Ç—å –†–ï–ê–õ–¨–ù–´–ï offset'—ã
                            let estimatedTopOffset = 0;
                            let estimatedLeftOffset = 0;

                            // –í—ã—á–∏—Å–ª—è–µ–º –∏–∑ —Ä–∞–∑–º–µ—Ä–æ–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è 0¬∞, 90¬∞, 180¬∞, 270¬∞)
                            if (diffHeight > 0) {
                                estimatedTopOffset = Math.min(diffHeight * 0.3, diffHeight / 2);
                            }
                            if (diffWidth > 0) {
                                estimatedLeftOffset = diffWidth / 2;
                            }

                            debugMessages.push(
                                `–†–∞–∑–º–µ—Ä—ã: screen=${window.screen.width}√ó${window.screen.height}, viewport=${window.innerWidth}√ó${window.innerHeight}`
                            );
                            debugMessages.push(
                                `–†–∞–∑–Ω–∏—Ü–∞: diffH=${diffHeight.toFixed(0)}, diffW=${diffWidth.toFixed(0)}`
                            );
                            debugMessages.push(
                                `–û—Ü–µ–Ω–∫–∞ offset (${currentOrientation}¬∞): top=${estimatedTopOffset.toFixed(1)}, left=${estimatedLeftOffset.toFixed(1)}`
                            );

                            // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ
                            const centerX = window.innerWidth / 2;
                            const centerY = window.innerHeight / 2;
                            const screenX = centerX + estimatedLeftOffset;
                            const screenY = centerY + estimatedTopOffset;

                            debugMessages.push(
                                `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: screenX=${screenX.toFixed(1)}, screenY=${screenY.toFixed(1)}`
                            );

                            const touch = new Touch({
                                identifier: Date.now(),
                                target: document.body,
                                clientX: centerX,
                                clientY: centerY,
                                screenX: screenX,
                                screenY: screenY,
                                radiusX: 5,
                                radiusY: 5,
                                rotationAngle: 0,
                                force: 0.5,
                            });

                            const customEvent = new TouchEvent('touchstart', {
                                bubbles: true,
                                cancelable: true,
                                touches: [touch],
                                targetTouches: [touch],
                                changedTouches: [touch],
                                ctrlKey: false,
                                shiftKey: false,
                                altKey: false,
                                metaKey: false,
                            });

                            updateDebugPanel({ debugInfo: debugMessages.join(' | ') });
                            calibrate(customEvent);

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ calibrate (–æ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
                            const newOffsets = loadOffsets();
                            if (newOffsets) {
                                const finalDebug = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: top=${newOffsets.top.toFixed(1)}, left=${newOffsets.left.toFixed(1)}`;
                                updateDebugPanel({ debugInfo: finalDebug });
                                // –ó–µ–ª–µ–Ω—ã–π –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏, —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ –±–µ–ª—ã–π
                                if (debugPanel) {
                                    debugPanel.style.background = 'rgb(200 255 200 / 90%)';
                                    setTimeout(() => {
                                        debugPanel.style.background = 'rgb(255 255 255 / 70%)';
                                    }, 1000);
                                }
                            } else {
                                // –û—Å—Ç–∞–µ—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
                                const finalDebug = `‚ùå Offset'—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ.`;
                                updateDebugPanel({ debugInfo: finalDebug });
                            }
                        } else {
                            debugMessages.push('‚è≥ –û–∂–∏–¥–∞–µ–º –∫–∞—Å–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                            document.addEventListener('touchstart', calibrate, {
                                passive: true,
                                once: true,
                            });
                            updateDebugPanel({ debugInfo: debugMessages.join(' | ') });
                        }
                    }
                }, 150);
            }

            function init() {
                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ touchstart –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                if ('ontouchstart' in window) {
                    document.addEventListener('touchstart', calibrate, { passive: true });
                }

                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–º–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                if ('ontouchstart' in window) {
                    window.addEventListener('orientationchange', handleOrientationChange);
                    if (screen.orientation) {
                        screen.orientation.addEventListener('change', handleOrientationChange);
                    }
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º offset'—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
                initializeOffsets();

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
                updateDebugPanel();
            }

            init();
        </script>
    </body>
</html>
