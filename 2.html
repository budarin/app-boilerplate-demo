<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Тест центрирования иконки splash screen по экрану</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            .icon {
                position: fixed;
                inset-block-start: var(--icon-top, 50%);
                inset-inline-start: var(--icon-left, 50%);
                transform: translate(-50%, -50%);

                inline-size: 120px;
                block-size: 120px;
                border-radius: 50%;

                background: linear-gradient(135deg, #41d1ff 0%, #bd34fe 100%);
            }

            .debug-panel {
                pointer-events: none;

                position: fixed;
                inset-block-start: 10px;
                inset-inline-end: 10px;

                padding: 8px;
                border-radius: 4px;

                font-family: monospace;
                font-size: 10px;
                line-height: 1.3;
                color: #000;

                background: rgb(255 255 255 / 70%);
            }

            .debug-row {
                margin-block-end: 2px;
                white-space: nowrap;
            }
        </style>
    </head>
    <body>
        <div class="icon" id="icon"></div>
        <div class="debug-panel" id="debugPanel"></div>

        <script>
            const STORAGE_PREFIX = 'splash_screen_offsets_';

            function getOrientation() {
                if (screen.orientation && typeof screen.orientation.angle !== 'undefined') {
                    return screen.orientation.angle;
                }
                return window.orientation || 0;
            }

            function getStorageKey() {
                const angle = getOrientation();
                return `${STORAGE_PREFIX}${angle}`;
            }

            // ===== Работа с localStorage =====

            function loadOffsets() {
                const key = getStorageKey();
                const stored = localStorage.getItem(key);
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            function saveOffsets(topOffset, leftOffset) {
                const key = getStorageKey();
                const data = {
                    top: topOffset,
                    left: leftOffset,
                };
                localStorage.setItem(key, JSON.stringify(data));
            }

            // ===== Калибровка через touchstart =====

            function calibrate(event) {
                const touch = event.touches ? event.touches[0] : event;
                let screenX = touch.screenX;
                let screenY = touch.screenY;
                const clientX = touch.clientX;
                const clientY = touch.clientY;

                // Проверяем доступность screenX/Y
                if (typeof screenX === 'undefined' || typeof screenY === 'undefined') {
                    // Fallback для десктопа
                    if (window.screenX > 0 || window.screenY > 0) {
                        screenX = window.screenX + clientX;
                        screenY = window.screenY + clientY;
                    } else {
                        return;
                    }
                }

                // Вычисляем offset'ы от краёв экрана
                const topOffset = screenY - clientY;
                const leftOffset = screenX - clientX;

                // Обновляем отладочную панель
                updateDebugPanel({
                    screenY,
                    clientY,
                    topOffset,
                    screenX,
                    clientX,
                    leftOffset,
                });

                // Загружаем существующие значения
                const existing = loadOffsets();

                // Проверяем, изменились ли значения (с погрешностью 1px)
                const hasChanged =
                    !existing ||
                    Math.abs(existing.top - topOffset) > 1 ||
                    Math.abs(existing.left - leftOffset) > 1;

                if (hasChanged) {
                    saveOffsets(topOffset, leftOffset);
                }

                // Всегда применяем offset'ы после касания
                applyOffsets(topOffset, leftOffset);
            }

            // ===== Применение offset'ов к CSS переменным =====

            function applyOffsets(topOffset, leftOffset) {
                // Если нет touch (десктоп), центрируем по viewport
                if (!('ontouchstart' in window)) {
                    document.documentElement.style.setProperty('--icon-top', '50%');
                    document.documentElement.style.setProperty('--icon-left', '50%');
                    return;
                }

                // Вычисляем позицию центра экрана в координатах viewport
                const screenCenterY = window.screen.height / 2;
                const screenCenterX = window.screen.width / 2;

                const iconTop = screenCenterY - topOffset;
                const iconLeft = screenCenterX - leftOffset;

                // Обновляем отладочную панель
                updateDebugPanel({
                    screenCenterY,
                    screenCenterX,
                    iconTop,
                    iconLeft,
                    topOffset,
                    leftOffset,
                });

                document.documentElement.style.setProperty('--icon-top', `${iconTop.toFixed(2)}px`);
                document.documentElement.style.setProperty(
                    '--icon-left',
                    `${iconLeft.toFixed(2)}px`
                );
            }

            // ===== Отладочная панель =====

            function updateDebugPanel(data = {}) {
                const panel = document.getElementById('debugPanel');
                if (!panel) return;

                const offsets = loadOffsets();
                const screenHeight = window.screen.height;
                const screenWidth = window.screen.width;
                const innerHeight = window.innerHeight;
                const innerWidth = window.innerWidth;
                const orientation = getOrientation();

                const computedStyle = getComputedStyle(document.documentElement);
                const iconTop = computedStyle.getPropertyValue('--icon-top').trim();
                const iconLeft = computedStyle.getPropertyValue('--icon-left').trim();

                panel.innerHTML = `
                    <div class="debug-row">Ориентация: ${orientation}°</div>
                    <div class="debug-row">Экран: ${screenWidth}×${screenHeight}</div>
                    <div class="debug-row">Viewport: ${innerWidth}×${innerHeight}</div>
                    ${
                        offsets
                            ? `
                    <div class="debug-row">Top offset: ${offsets.top.toFixed(1)}px</div>
                    <div class="debug-row">Left offset: ${offsets.left.toFixed(1)}px</div>
                    `
                            : '<div class="debug-row">Не калибровано</div>'
                    }
                    ${
                        data.screenCenterY !== undefined
                            ? `
                    <div class="debug-row">Центр экрана Y: ${data.screenCenterY.toFixed(1)}px</div>
                    <div class="debug-row">Иконка top: ${data.iconTop?.toFixed(1) || '—'}px</div>
                    `
                            : ''
                    }
                    ${
                        data.screenY !== undefined
                            ? `
                    <div class="debug-row">Touch screenY: ${data.screenY.toFixed(1)}</div>
                    <div class="debug-row">Touch clientY: ${data.clientY.toFixed(1)}</div>
                    `
                            : ''
                    }
                    <div class="debug-row">CSS top: ${iconTop || '50%'}</div>
                `;
            }

            // ===== Инициализация offset'ов при загрузке =====

            function initializeOffsets() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                    return true;
                }
                // Если нет offset'ов и нет touch - центрируем по viewport (для десктопа)
                if (!('ontouchstart' in window)) {
                    applyOffsets(0, 0);
                }
                return false;
            }

            // ===== Обработка смены ориентации =====

            function handleOrientationChange() {
                const offsets = loadOffsets();
                if (offsets) {
                    applyOffsets(offsets.top, offsets.left);
                }
            }

            function init() {
                // Регистрируем обработчик touchstart для калибровки
                document.addEventListener('touchstart', calibrate, { passive: true });

                // Регистрируем обработчики смены ориентации
                if ('ontouchstart' in window) {
                    window.addEventListener('orientationchange', handleOrientationChange);
                    if (screen.orientation) {
                        screen.orientation.addEventListener('change', handleOrientationChange);
                    }
                }

                // Обработка resize (может измениться размер viewport)
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        const offsets = loadOffsets();
                        if (offsets) {
                            applyOffsets(offsets.top, offsets.left);
                        } else {
                            applyOffsets(0, 0);
                        }
                    }, 100);
                });

                // Загружаем offset'ы при запуске
                initializeOffsets();

                // Обновляем отладочную панель
                updateDebugPanel();
            }

            // Запуск при загрузке DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        </script>
    </body>
</html>
