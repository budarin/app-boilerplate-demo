<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#673ab7">
    <title>PWA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            min-height: 100vh; 
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #f5f5f5;
            z-index: 9999;
        }
        
        .splash__icon {
            width: 100px;
            height: 100px;
            background: #3498db;
            border-radius: 50%;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: var(--splash-icon-top);
        }
        
        .app {
            display: none;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="splash">
        <div class="splash__icon"></div>
    </div>
    
    <div class="app">
        <h1>Приложение загружено</h1>
        <p>Коснись экрана в любом месте для калибровки следующего запуска</p>
    </div>

    <script>
        const STORAGE_KEY = 'pwa_viewport_offset';
        
        function getOrientation() {
            return window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
        }
        
        function getStorageKey() {
            const orientation = getOrientation();
            const screenHeight = window.screen.height;
            return `${STORAGE_KEY}_${orientation}_${screenHeight}`;
        }
        
        function loadViewportOffset() {
            const key = getStorageKey();
            const stored = localStorage.getItem(key);
            return stored ? parseFloat(stored) : null;
        }
        
        function saveViewportOffset(offset) {
            const key = getStorageKey();
            localStorage.setItem(key, offset.toString());
        }
        
        function calculateSplashPosition() {
            const screenHeight = window.screen.height;
            const innerHeight = window.innerHeight;
            const iconHeight = 100;
            
            // Пробуем загрузить сохранённый offset
            let viewportOffset = loadViewportOffset();
            
            if (viewportOffset === null) {
                // Первый запуск - используем приближение
                viewportOffset = (screenHeight - innerHeight) / 2;
            }
            
            // Вычисляем позицию иконки
            const screenCenter = screenHeight / 2;
            const topPosition = screenCenter - viewportOffset - (iconHeight / 2);
            
            document.documentElement.style.setProperty(
                '--splash-icon-top',
                `${Math.round(topPosition)}px`
            );
        }
        
        // Калибровка при касании
        let calibrated = false;
        
        function calibrate(e) {
            if (calibrated) return;
            
            const touch = e.touches ? e.touches[0] : e;
            const clientY = touch.clientY;
            const screenY = touch.screenY;
            
            // Вычисляем точный viewport offset
            const viewportOffset = screenY - clientY;
            
            // Сохраняем
            saveViewportOffset(viewportOffset);
            calibrated = true;
            
            console.log(`Calibrated: viewport offset = ${viewportOffset}px`);
        }
        
        document.addEventListener('touchstart', calibrate, { once: true, passive: true });
        document.addEventListener('click', calibrate, { once: true });
        
        // Повторная калибровка при смене ориентации
        window.addEventListener('orientationchange', () => {
            calibrated = false;
            setTimeout(() => {
                calculateSplashPosition();
            }, 300);
        });
        
        // Инициализация при загрузке
        calculateSplashPosition();
        
        // Имитация загрузки приложения
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Скрываем splash
                const splash = document.querySelector('.splash');
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 0.3s';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    document.querySelector('.app').style.display = 'block';
                }, 300);
            }, 2000);
        });
    </script>
</body>
</html>
