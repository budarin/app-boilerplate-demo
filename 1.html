<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#673ab7" />
    <title>PWA</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        min-height: 100vh;
        background: #f5f5f5;
        overflow: hidden;
      }

      .splash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: #f5f5f5;
        z-index: 9999;
      }

      .splash__icon {
        width: 100px;
        height: 100px;
        background: #3498db;
        border-radius: 50%;
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: var(--splash-icon-top);
      }

      .app {
        display: none;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="splash">
      <div class="splash__icon"></div>
    </div>

    <div class="app">
      <h1>Приложение загружено</h1>
      <p>Коснись экрана в любом месте для калибровки следующего запуска</p>
    </div>

    <script>
      const STORAGE_KEY = "pwa_viewport_offset";

      function getOrientation() {
        return window.innerWidth > window.innerHeight
          ? "landscape"
          : "portrait";
      }

      function getStorageKey() {
        const orientation = getOrientation();
        const screenHeight = window.screen.height;
        return `${STORAGE_KEY}_${orientation}_${screenHeight}`;
      }

      function loadViewportOffset() {
        const key = getStorageKey();
        const stored = localStorage.getItem(key);
        return stored ? parseFloat(stored) : null;
      }

      function saveViewportOffset(offset) {
        const key = getStorageKey();
        localStorage.setItem(key, offset.toString());
      }

      function calculateSplashPosition() {
        const screenHeight = window.screen.height;
        const innerHeight = window.innerHeight;
        const iconHeight = 100;

        // Загружаем сохранённый offset для текущей ориентации
        let viewportOffset = loadViewportOffset();

        if (viewportOffset === null) {
          // Данных нет - используем приближение
          viewportOffset = (screenHeight - innerHeight) / 2;
        }

        // Вычисляем позицию
        const screenCenter = screenHeight / 2;
        const topPosition = screenCenter - viewportOffset - iconHeight / 2;

        document.documentElement.style.setProperty(
          "--splash-icon-top",
          `${Math.round(topPosition)}px`
        );
      }

      // Калибровка при касании (только если данных нет)
      function calibrate(e) {
        // Проверяем - есть ли уже данные для текущей ориентации
        if (loadViewportOffset() !== null) {
          return; // Уже откалибровано, ничего не делаем
        }

        const touch = e.touches ? e.touches[0] : e;
        const clientY = touch.clientY;
        const screenY = touch.screenY;

        const viewportOffset = screenY - clientY;
        saveViewportOffset(viewportOffset);

        // Пересчитываем позицию с точным значением
        calculateSplashPosition();

        console.log(
          `Calibrated for ${getOrientation()}: offset = ${viewportOffset}px`
        );
      }

      document.addEventListener("touchstart", calibrate, { passive: true });
      document.addEventListener("click", calibrate);

      // При смене ориентации - просто пересчитываем позицию
      window.addEventListener("orientationchange", () => {
        setTimeout(() => {
          calculateSplashPosition();
          // Если для новой ориентации нет данных - следующее касание откалибрует
        }, 300);
      });

      // Инициализация
      calculateSplashPosition();
    </script>
  </body>
</html>
